http:
  middlewares:
    # CrowdSec bouncer – blocks IPs flagged by the CrowdSec LAPI.
    # The API key (crowdsecLapiKey) is substituted from TRAEFIK_CROWDSEC_BOUNCER_KEY
    # in your .env file by render-config.sh, or injected automatically by the
    # crowdsec-init container.  After init, restart Traefik:
    #   docker compose restart traefik
    crowdsec:
      plugin:
        crowdsec-bouncer:
          enabled: true
          crowdsecLapiKey: ${TRAEFIK_CROWDSEC_BOUNCER_KEY}
          crowdsecLapiHost: crowdsec:8080
          crowdsecLapiScheme: http
          crowdsecMode: live
          updateIntervalSeconds: 15
          defaultDecisionSeconds: 60
          httpTimeout: 10
          # Use CF-Connecting-IP as the real client IP when behind Cloudflare
          forwardedHeadersCustomName: CF-Connecting-IP
          # AppSec component – forwards requests to CrowdSec for WAF-style inspection.
          # Requires the crowdsecurity/appsec-virtual-patching and
          # crowdsecurity/appsec-generic-rules collections to be installed (via the
          # COLLECTIONS env var in docker-compose.yml) and the
          # crowdsec/acquis.d/appsec.yaml acquisition config in the CrowdSec container.
          crowdsecAppsecEnabled: true
          crowdsecAppsecHost: crowdsec:7422
          crowdsecAppsecFailureBlock: false
          crowdsecAppsecUnreachableBlock: false

    # HTTP → HTTPS permanent redirect
    redirect-to-https:
      redirectScheme:
        scheme: https
        permanent: true

    # Traefik dashboard BasicAuth (optional – Cloudflare Access is the primary control).
    # Uncomment and fill in to add a second auth layer in front of the dashboard.
    # Generate an htpasswd entry (requires apache2-utils / httpd-tools):
    #   echo $(htpasswd -nb <user> <password>) | sed -e 's/\$/\$\$/g'
    # IMPORTANT: every $ in the htpasswd output must be doubled ($$) in this file.
    #
    # dashboard-auth:
    #   basicAuth:
    #     users:
    #       - "admin:$$apr1$$example$$hashedpasswordhere"

  routers:
    # Traefik dashboard router.
    # The Cloudflare Tunnel routes a second public hostname (TRAEFIK_DASHBOARD_HOSTNAME)
    # to https://traefik:443; Traefik matches it here and serves the dashboard UI.
    # The Origin Certificate (traefik/dynamic/tls.yml) provides the TLS for this route.
    # Protect this route with a Cloudflare Access policy (recommended) and/or
    # uncomment the dashboard-auth middleware above for BasicAuth.
    traefik-dashboard:
      rule: "Host(`${TRAEFIK_DASHBOARD_HOSTNAME}`)"
      entryPoints:
        - websecure
      service: api@internal
      tls: {}
      middlewares:
        - crowdsec@file
        # - dashboard-auth@file  # Uncomment to enable BasicAuth (configure above first)


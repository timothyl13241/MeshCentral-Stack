# Traefik v3 static configuration
# Traffic flow: Cloudflare Tunnel → Traefik (Origin Cert, HTTPS) → MeshCentral
#
# TLS (end-to-end SSL):
#   - Cloudflare Origin Certificate is loaded via dynamic/tls.yml (defaultCertificate).
#   - Cloudflare Tunnel connects to Traefik on port 443 using HTTPS (Full/Strict mode).
#   - Traefik proxies to MeshCentral on port 4430; MeshCentral uses TlsOffload to
#     recognise connections from the frontend subnet as already TLS-terminated.
#
# CrowdSec integration:
#   - JSON access log is written to /var/log/traefik/access.log (parsed by CrowdSec)
#   - crowdsec-bouncer plugin applies CrowdSec LAPI decisions as a middleware
#
# Run with: docker compose --profile traefik up -d

api:
  # Enable the dashboard UI.
  # The dashboard is exposed via the router defined in dynamic/middlewares.yml
  # (matched on TRAEFIK_DASHBOARD_HOSTNAME) so it is reachable through the
  # Cloudflare Tunnel on its own public hostname without opening an extra port.
  dashboard: true

# Health-check endpoint served on the dedicated internal entrypoint (port 8082)
ping:
  entryPoint: traefik

log:
  level: INFO
  filePath: /var/log/traefik/traefik.log

# JSON access log – consumed by CrowdSec (crowdsecurity/traefik collection)
accessLog:
  filePath: /var/log/traefik/access.log
  format: json
  fields:
    headers:
      defaultMode: drop
      names:
        CF-Connecting-IP: keep
        X-Forwarded-For: keep
        X-Real-IP: keep

entryPoints:
  web:
    address: ":80"
  websecure:
    address: ":443"
  # Internal entrypoint for ping / health checks only
  traefik:
    address: ":8082"

providers:
  # Docker provider – discovers containers via traefik.* labels
  docker:
    exposedByDefault: false
    network: meshcentral-frontend
  # File provider – dynamic config directory, watched for live changes
  file:
    directory: /etc/traefik/dynamic
    watch: true

# CrowdSec bouncer Traefik plugin
# The plugin is downloaded from the Traefik plugin registry at startup.
# API key is injected into dynamic/middlewares.yml by the crowdsec-init container.
experimental:
  plugins:
    crowdsec-bouncer:
      moduleName: "github.com/maxlerebourg/crowdsec-bouncer-traefik-plugin"
      version: "v1.3.5"

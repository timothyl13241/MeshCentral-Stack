# Traefik v3 static configuration
# Traffic flow: Cloudflare Tunnel → Traefik (Origin Cert, HTTPS) → MeshCentral
#
# TLS (end-to-end SSL):
#   - Cloudflare Origin Certificate is loaded via dynamic/tls.yml (defaultCertificate).
#   - Cloudflare Tunnel connects to Traefik on port 443 using HTTPS (Full/Strict mode).
#   - Traefik proxies to MeshCentral on port 4430; MeshCentral uses TlsOffload to
#     recognise connections from the frontend subnet as already TLS-terminated.
#
# IP forwarding (required for UserAllowedIP and CrowdSec):
#   - Cloudflare Tunnel sends CF-Connecting-IP / X-Forwarded-For with the real client IP.
#   - forwardedHeaders.trustedIPs on both entrypoints lists every Cloudflare proxy CIDR.
#   - Traefik therefore passes the *real* client IP in X-Forwarded-For to MeshCentral.
#   - MeshCentral trusts X-Forwarded-For from the TlsOffload subnet (172.19.0.0/16)
#     and uses the real IP for UserAllowedIP enforcement and CrowdSec decisions.
#
# CrowdSec integration:
#   - JSON access log is written to /var/log/traefik/access.log (parsed by CrowdSec)
#   - crowdsec-bouncer plugin applies CrowdSec LAPI decisions as a middleware
#
# Metrics:
#   - Prometheus metrics are exposed on the internal entrypoint (port 8082) at /metrics
#   - Scrape with: http://<traefik-host>:8082/metrics
#
# Run with: docker compose --profile traefik up -d

api:
  # Enable the dashboard UI.
  # The dashboard is exposed via the router defined in dynamic/middlewares.yml
  # (matched on TRAEFIK_DASHBOARD_HOSTNAME) so it is reachable through the
  # Cloudflare Tunnel on its own public hostname without opening an extra port.
  dashboard: true

# Health-check endpoint served on the dedicated internal entrypoint (port 8082)
ping:
  entryPoint: traefik

log:
  level: INFO
  filePath: /var/log/traefik/traefik.log

# JSON access log – consumed by CrowdSec (crowdsecurity/traefik collection)
accessLog:
  filePath: /var/log/traefik/access.log
  format: json
  fields:
    headers:
      defaultMode: drop
      names:
        CF-Connecting-IP: keep
        X-Forwarded-For: keep
        X-Real-IP: keep

entryPoints:
  web:
    address: ":80"
    forwardedHeaders:
      # Trust Cloudflare proxy IPs so the real client IP is forwarded correctly.
      # See: https://www.cloudflare.com/ips/
      trustedIPs:
        - "173.245.48.0/20"
        - "103.21.244.0/22"
        - "103.22.200.0/22"
        - "103.31.4.0/22"
        - "141.101.64.0/18"
        - "108.162.192.0/18"
        - "190.93.240.0/20"
        - "188.114.96.0/20"
        - "197.234.240.0/22"
        - "198.41.128.0/17"
        - "162.158.0.0/15"
        - "104.16.0.0/13"
        - "104.24.0.0/14"
        - "172.64.0.0/13"
        - "131.0.72.0/22"
        - "2400:cb00::/32"
        - "2606:4700::/32"
        - "2803:f800::/32"
        - "2405:b500::/32"
        - "2405:8100::/32"
        - "2a06:98c0::/29"
        - "2c0f:f248::/32"
  websecure:
    address: ":443"
    forwardedHeaders:
      # Trust Cloudflare proxy IPs so the real client IP is forwarded correctly.
      # See: https://www.cloudflare.com/ips/
      trustedIPs:
        - "173.245.48.0/20"
        - "103.21.244.0/22"
        - "103.22.200.0/22"
        - "103.31.4.0/22"
        - "141.101.64.0/18"
        - "108.162.192.0/18"
        - "190.93.240.0/20"
        - "188.114.96.0/20"
        - "197.234.240.0/22"
        - "198.41.128.0/17"
        - "162.158.0.0/15"
        - "104.16.0.0/13"
        - "104.24.0.0/14"
        - "172.64.0.0/13"
        - "131.0.72.0/22"
        - "2400:cb00::/32"
        - "2606:4700::/32"
        - "2803:f800::/32"
        - "2405:b500::/32"
        - "2405:8100::/32"
        - "2a06:98c0::/29"
        - "2c0f:f248::/32"
  # Internal entrypoint for ping / health checks / metrics only
  traefik:
    address: ":8082"

providers:
  # Docker provider – discovers containers via traefik.* labels
  docker:
    exposedByDefault: false
    network: meshcentral-frontend
  # File provider – dynamic config directory, watched for live changes
  file:
    directory: /etc/traefik/dynamic
    watch: true

# Prometheus metrics – scraped from the internal entrypoint (port 8082)
# alongside the ping / health-check endpoint.
# To scrape, configure Prometheus with: http://<traefik-host>:8082/metrics
metrics:
  prometheus:
    addEntryPointsLabels: true
    addRoutersLabels: true
    addServicesLabels: true
    entryPoint: traefik

# CrowdSec bouncer Traefik plugin
# The plugin is downloaded from the Traefik plugin registry at startup.
# API key is injected into dynamic/middlewares.yml by the crowdsec-init container.
experimental:
  plugins:
    crowdsec-bouncer:
      moduleName: "github.com/maxlerebourg/crowdsec-bouncer-traefik-plugin"
      version: "v1.3.5"

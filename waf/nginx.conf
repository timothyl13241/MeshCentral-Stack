# nginx reverse-proxy configuration for the MeshCentral WAF service.
# Copied into the container image at build time via waf/Dockerfile.
# Placed in /etc/nginx/templates/conf.d/ so the nginx startup script renders
# it to /etc/nginx/conf.d/default.conf via envsubst.  nginx variables such as
# $host and $remote_addr are NOT shell environment variables and are therefore
# left untouched by envsubst — they are interpreted by nginx at runtime.
#
# Traffic flow: cloudflared → waf (this file) → meshcentral
#
# ModSecurity engine and OWASP CRS rules are loaded by setup.conf (pre-loaded
# by the owasp/modsecurity-crs base image); waf/modsecurity.conf is copied to
# /etc/modsecurity.d/modsecurity-override.conf for production settings.

# Upstream: internal MeshCentral application container (port 4430)
upstream meshcentral {
    server meshcentral:4430;
    keepalive 32;
}

# HTTP listener – proxies traffic to MeshCentral after WAF inspection.
# When using Cloudflare Tunnel (cloudflared → waf), HTTP is sufficient
# for the internal leg because TLS is terminated by Cloudflare.
server {
    listen 80;
    server_name _;

    # Enable ModSecurity WAF; this directive loads the OWASP CRS rules bundle
    # (modsecurity.conf + CRS rules) that the base image provides at this path.
    modsecurity on;
    modsecurity_rules_file /etc/modsecurity.d/setup.conf;

    # Forward real client IP through the proxy chain
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # WebSocket support required by MeshCentral agent connections
    proxy_http_version 1.1;
    proxy_set_header   Upgrade    $http_upgrade;
    proxy_set_header   Connection "upgrade";

    # Increase timeouts for long-lived agent connections
    proxy_read_timeout 3600s;
    proxy_send_timeout 3600s;

    location / {
        proxy_pass http://meshcentral;
    }
}

# HTTPS listener – supply your own certificate files when TLS termination
# is handled by the WAF rather than Cloudflare Tunnel.
server {
    listen 443 ssl;
    server_name _;

    # TLS termination – replace with your certificate paths.
    # When using Cloudflare Tunnel (cloudflared → waf), TLS is terminated
    # by Cloudflare; a self-signed certificate is sufficient here.
    #
    # Mount your certificates in docker-compose.yml (see commented-out volume
    # entries in the waf service) and place the files in waf/ssl/:
    #   waf/ssl/cert.pem  →  /etc/nginx/ssl/cert.pem
    #   waf/ssl/key.pem   →  /etc/nginx/ssl/key.pem
    ssl_certificate     /etc/nginx/ssl/cert.pem;
    ssl_certificate_key /etc/nginx/ssl/key.pem;
    ssl_protocols       TLSv1.2 TLSv1.3;
    ssl_ciphers         HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers on;

    # Enable ModSecurity WAF; this directive loads the OWASP CRS rules bundle
    # (modsecurity.conf + CRS rules) that the base image provides at this path.
    modsecurity on;
    modsecurity_rules_file /etc/modsecurity.d/setup.conf;

    # Forward real client IP through the proxy chain
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # WebSocket support required by MeshCentral agent connections
    proxy_http_version 1.1;
    proxy_set_header   Upgrade    $http_upgrade;
    proxy_set_header   Connection "upgrade";

    # Increase timeouts for long-lived agent connections
    proxy_read_timeout 3600s;
    proxy_send_timeout 3600s;

    location / {
        proxy_pass http://meshcentral;
    }
}

# nginx reverse-proxy virtual-host configuration for the MeshCentral WAF service.
# Copied into the container image at build time via waf/Dockerfile.
# No envsubst / entrypoint templating – all values are static.
#
# Traffic flow: cloudflared → waf (this file) → meshcentral

# Upstream: internal MeshCentral application container (port 4430)
upstream meshcentral {
    server meshcentral:4430;
    keepalive 32;
}

# HTTP listener – proxies traffic to MeshCentral after WAF inspection.
# When using Cloudflare Tunnel (cloudflared → waf), HTTP is sufficient
# for the internal leg because TLS is terminated by Cloudflare.
server {
    listen 80;
    server_name _;

    # Enable ModSecurity with the OWASP CRS rules loaded from setup.conf
    modsecurity on;
    modsecurity_rules_file /etc/modsecurity.d/setup.conf;

    # Forward real client IP through the proxy chain
    proxy_set_header Host              $host;
    proxy_set_header X-Real-IP         $remote_addr;
    proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # WebSocket support required by MeshCentral agent connections
    proxy_http_version 1.1;
    proxy_set_header   Upgrade    $http_upgrade;
    proxy_set_header   Connection "upgrade";

    # Increase timeouts for long-lived agent connections
    proxy_read_timeout 3600s;
    proxy_send_timeout 3600s;

    location / {
        proxy_pass http://meshcentral:4430;
    }
}

# HTTPS listener – uncomment when terminating TLS at the WAF instead of
# Cloudflare Tunnel.  Uncomment the certificate volume mounts in
# docker-compose.yml and place your files in waf/ssl/:
#   waf/ssl/cert.pem  →  /etc/nginx/ssl/cert.pem
#   waf/ssl/key.pem   →  /etc/nginx/ssl/key.pem
#
# server {
#     listen 443 ssl;
#     server_name _;
#
#     ssl_certificate     /etc/nginx/ssl/cert.pem;
#     ssl_certificate_key /etc/nginx/ssl/key.pem;
#     ssl_protocols       TLSv1.2 TLSv1.3;
#     ssl_ciphers         HIGH:!aNULL:!MD5;
#     ssl_prefer_server_ciphers on;
#
#     modsecurity on;
#     modsecurity_rules_file /etc/modsecurity.d/setup.conf;
#
#     proxy_set_header Host              $host;
#     proxy_set_header X-Real-IP         $remote_addr;
#     proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
#     proxy_set_header X-Forwarded-Proto $scheme;
#
#     proxy_http_version 1.1;
#     proxy_set_header   Upgrade    $http_upgrade;
#     proxy_set_header   Connection "upgrade";
#
#     proxy_read_timeout 3600s;
#     proxy_send_timeout 3600s;
#
#     location / {
#         proxy_pass http://meshcentral;
#     }
# }

# ModSecurity configuration for the MeshCentral WAF service.
# Mounted at /etc/nginx/modsecurity.conf inside the container.
#
# This file enables ModSecurity with the OWASP Core Rule Set (CRS).
# Paths below match the jasonish/nginx-modsecurity image layout; adjust
# if a different image version places CRS files elsewhere.

# --------------------------------------------------------------------------
# Engine mode
#   DetectionOnly – log violations without blocking (safe for initial testing)
#   On            – actively block detected attacks (recommended for production)
# --------------------------------------------------------------------------
SecRuleEngine DetectionOnly

# --------------------------------------------------------------------------
# Request body processing
# --------------------------------------------------------------------------
SecRequestBodyAccess On
# Maximum request body size (bytes) – increase if MeshCentral file uploads fail
SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 131072

# --------------------------------------------------------------------------
# Response body processing
# --------------------------------------------------------------------------
SecResponseBodyAccess On
SecResponseBodyMimeType text/plain text/html text/xml
SecResponseBodyLimit 524288

# --------------------------------------------------------------------------
# Audit logging
# Log only relevant events to keep the audit log manageable.
# CrowdSec can be pointed at /var/log/nginx to analyse WAF access logs.
# --------------------------------------------------------------------------
SecAuditEngine RelevantOnly
SecAuditLog /var/log/nginx/modsec_audit.log
SecAuditLogParts ABIJDEFHkZ
SecAuditLogType Serial
SecAuditLogFormat JSON

# --------------------------------------------------------------------------
# Default action (pass – let CRS rules decide blocking based on SecRuleEngine)
# --------------------------------------------------------------------------
SecDefaultAction "phase:1,log,auditlog,pass"

# --------------------------------------------------------------------------
# OWASP Core Rule Set (CRS)
# Paths below match the jasonish/nginx-modsecurity image layout; adjust if
# a different image version places CRS files elsewhere.
#
# NOTE: If these paths do not exist in the image, ModSecurity will cause
# nginx to fail at startup rather than silently skip the rules.
# Verify the config is valid after updating with:
#   docker compose exec waf nginx -t
# --------------------------------------------------------------------------
Include /etc/modsecurity.d/owasp-crs/crs-setup.conf
Include /etc/modsecurity.d/owasp-crs/rules/*.conf

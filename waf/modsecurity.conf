# ModSecurity override configuration for the MeshCentral WAF service.
# Mounted at /etc/modsecurity.d/modsecurity-override.conf inside the container.
#
# The owasp/modsecurity-crs:nginx image pre-loads ModSecurity + the OWASP CRS
# via /etc/modsecurity.d/setup.conf (which includes modsecurity.conf and the
# full CRS rule set).  This file is loaded afterwards as an override, so only
# add directives that you want to change from the image defaults.

# --------------------------------------------------------------------------
# Engine mode
#   DetectionOnly – log violations without blocking (safe for initial testing)
#   On            – actively block detected attacks (recommended for production)
# --------------------------------------------------------------------------
SecRuleEngine DetectionOnly

# --------------------------------------------------------------------------
# Request body processing
# --------------------------------------------------------------------------
SecRequestBodyAccess On
# Maximum request body size (bytes) – increase if MeshCentral file uploads fail
SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 131072

# --------------------------------------------------------------------------
# Response body processing
# --------------------------------------------------------------------------
SecResponseBodyAccess On
SecResponseBodyMimeType text/plain text/html text/xml
SecResponseBodyLimit 524288

# --------------------------------------------------------------------------
# Audit logging
# Log only relevant events to keep the audit log manageable.
# CrowdSec can be pointed at /var/log/nginx to analyse WAF access logs.
# --------------------------------------------------------------------------
SecAuditEngine RelevantOnly
SecAuditLog /var/log/nginx/modsec_audit.log
SecAuditLogParts ABIJDEFHkZ
SecAuditLogType Serial
SecAuditLogFormat JSON

# --------------------------------------------------------------------------
# Default action (pass – let CRS rules decide blocking based on SecRuleEngine)
# --------------------------------------------------------------------------
SecDefaultAction "phase:1,log,auditlog,pass"

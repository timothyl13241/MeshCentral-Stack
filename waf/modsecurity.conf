# ModSecurity v3 engine configuration for the MeshCentral WAF service.
# Copied into the container image at build time via waf/Dockerfile.
# Also bind-mounted at runtime (see docker-compose.yml waf service volumes)
# so you can tune SecRuleEngine / limits with only a container restart instead
# of a full image rebuild.

# --------------------------------------------------------------------------
# Engine mode
#   DetectionOnly – log violations without blocking (safe for initial testing)
#   On            – actively block detected attacks (recommended for production)
# --------------------------------------------------------------------------
SecRuleEngine DetectionOnly

# --------------------------------------------------------------------------
# Request body processing
# --------------------------------------------------------------------------
SecRequestBodyAccess On
# Maximum request body size (bytes) – increase if MeshCentral file uploads fail
SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 131072

# --------------------------------------------------------------------------
# Response body processing
# --------------------------------------------------------------------------
SecResponseBodyAccess On
SecResponseBodyMimeType text/plain text/html text/xml
SecResponseBodyLimit 524288

# --------------------------------------------------------------------------
# Temporary and data directories (writable by nginx)
# --------------------------------------------------------------------------
SecTmpDir /tmp
SecDataDir /tmp

# --------------------------------------------------------------------------
# Audit logging
# Log only relevant events to keep the audit log manageable.
# CrowdSec can be pointed at /var/log/nginx to analyse WAF access logs.
# --------------------------------------------------------------------------
SecAuditEngine RelevantOnly
SecAuditLog /var/log/nginx/modsec_audit.log
SecAuditLogParts ABIJDEFH
SecAuditLogType Serial
SecAuditLogFormat JSON

# --------------------------------------------------------------------------
# Default action (pass – let CRS rules decide blocking based on SecRuleEngine)
# --------------------------------------------------------------------------
# SecDefaultAction "phase:1,log,auditlog,pass"

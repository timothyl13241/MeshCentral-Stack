{
	# Global options
	admin 0.0.0.0:2019
	
	# Email for ACME (Let's Encrypt)
	email {$ACME_EMAIL}

	# DNS configuration
	acme_dns cloudflare {$CLOUDFLARE_API_TOKEN}
	
	# Log configuration
	log {
		output file /data/access.log {
			roll_size 10MB
			roll_keep 10
		}
		format json
	}
}

# MeshCentral site configuration
{$MESHCENTRAL_HOSTNAME} {
	# Enable TLS
	tls {
		protocols tls1.2 tls1.3
		dns cloudflare {$CLOUDFLARE_API_TOKEN}
	}

	# Add security headers
	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		X-Frame-Options "SAMEORIGIN"
		X-Content-Type-Options "nosniff"
		X-XSS-Protection "1; mode=block"
		Referrer-Policy "strict-origin-when-cross-origin"
		-Server
	}

	# Requests coming from Cloudflare (CF-Connecting-IP present)
	@cloudflare header CF-Connecting-IP *
	
	handle @cloudflare {
		reverse_proxy meshcentral:4430 {
			# Real client IP from Cloudflare
			header_up X-Real-IP {header.CF-Connecting-IP}
			header_up CF-Connecting-IP {header.CF-Connecting-IP}
	
			# Let Caddy manage X-Forwarded-For (it appends correctly)
			# (do NOT override X-Forwarded-For here)
	
			# WebSocket support
			header_up Upgrade {http.request.header.Upgrade}
			header_up Connection {http.request.header.Connection}
	
			# Preserve host/proto
			header_up Host {host}
			header_up X-Forwarded-Proto {scheme}
			header_up X-Forwarded-Host {host}
		}
	}

	# Default handler for non-Cloudflare traffic
	handle {
		reverse_proxy meshcentral:4430 {
			# Non-Cloudflare: use remote client IP
			header_up X-Real-IP {remote_host}
	
			# Let Caddy manage X-Forwarded-For
			# (do NOT override X-Forwarded-For here either)
	
			# WebSocket support
			header_up Upgrade {http.request.header.Upgrade}
			header_up Connection {http.request.header.Connection}
	
			header_up Host {host}
			header_up X-Forwarded-Proto {scheme}
			header_up X-Forwarded-Host {host}
		}
	}

	encode gzip zstd

	log {
		output file /data/meshcentral-access.log {
			roll_size 10MB
			roll_keep 10
		}
		format json
	}
}

# HTTP to HTTPS redirect (if needed)
http://{$MESHCENTRAL_HOSTNAME} {
	redir https://{host}{uri} permanent
}

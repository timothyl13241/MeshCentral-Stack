{
	# Global options
	admin 0.0.0.0:2019
	
	# Email for ACME (Let's Encrypt)
	email {$ACME_EMAIL}

	# DNS configuration
	acme_dns cloudflare {$CLOUDFLARE_API_TOKEN}
	
	# Log configuration
	log {
		output file /data/access.log {
			roll_size 10MB
			roll_keep 10
		}
		format json
	}
}

# MeshCentral site configuration
{$MESHCENTRAL_HOSTNAME} {
	# Enable TLS
	tls {
		protocols tls1.2 tls1.3
		dns cloudflare {env.CLOUDFLARE_API_TOKEN}
	}

	# Add security headers
	header {
		Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
		X-Frame-Options "SAMEORIGIN"
		X-Content-Type-Options "nosniff"
		X-XSS-Protection "1; mode=block"
		Referrer-Policy "strict-origin-when-cross-origin"
		-Server
	}

	# Requests coming from Cloudflare (CF-Connecting-IP present)
	@cloudflare header CF-Connecting-IP *

	handle @cloudflare {
		reverse_proxy meshcentral:4430 {
			# Preserve real client IP from Cloudflare
			header_up X-Real-IP {header.CF-Connecting-IP}
			header_up X-Forwarded-For {header.CF-Connecting-IP}

			# WebSocket support
			header_up Upgrade {http.request.header.Upgrade}
			header_up Connection {http.request.header.Connection}

			# Pass through other important headers
			header_up Host {host}
			header_up X-Forwarded-Proto {scheme}
			header_up X-Forwarded-Host {host}

			# Health check
			health_uri /
			health_interval 30s
			health_timeout 10s
		}
	}

	# Default handler for non-Cloudflare traffic
	handle {
		reverse_proxy meshcentral:4430 {
			# Preserve real client IP
			header_up X-Real-IP {remote_host}
			header_up X-Forwarded-For {remote_host}

			# WebSocket support
			header_up Upgrade {http.request.header.Upgrade}
			header_up Connection {http.request.header.Connection}

			# Pass through standard headers
			header_up Host {host}
			header_up X-Forwarded-Proto {scheme}
			header_up X-Forwarded-Host {host}

			# Health check
			health_uri /
			health_interval 30s
			health_timeout 10s
		}
	}

	encode gzip zstd

	log {
		output file /data/meshcentral-access.log {
			roll_size 10MB
			roll_keep 10
		}
		format json
	}
}

# HTTP to HTTPS redirect (if needed)
http://{$MESHCENTRAL_HOSTNAME} {
	redir https://{host}{uri} permanent
}

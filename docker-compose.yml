services:
  # MongoDB Database
  mongodb:
    image: mongo:7
    container_name: meshcentral-mongodb
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD}
      MONGO_INITDB_DATABASE: ${MONGO_DATABASE}
      MESHCENTRAL_USER: ${MESHCENTRAL_DB_USER}
      MESHCENTRAL_PASSWORD: ${MESHCENTRAL_DB_PASSWORD}
    volumes:
      - mongodb-data:/data/db
      - mongodb-config:/data/configdb
      - ./mongo-init/init-mongo.js:/docker-entrypoint-initdb.d/init-mongo.js:ro
    networks:
      - meshcentral-backend
    command: 
      - --auth
      # Enable encryption at rest (requires keyfile configuration in production)
      # - --enableEncryption
      # - --encryptionKeyFile=/etc/mongodb-keyfile
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/${MONGO_DATABASE} --quiet
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # CrowdSec Security Engine (Optional - comment out if not using)
  crowdsec:
    image: crowdsecurity/crowdsec:latest
    container_name: meshcentral-crowdsec
    restart: unless-stopped
    environment:
      # CrowdSec collections to install
      # crowdsecurity/traefik parses Traefik JSON access logs
      # crowdsecurity/appsec-virtual-patching and crowdsecurity/appsec-generic-rules
      # enable the AppSec component (WAF-style request inspection via port 7422)
      COLLECTIONS: "crowdsecurity/http-cve crowdsecurity/whitelist-good-actors crowdsecurity/iptables crowdsecurity/linux crowdsecurity/traefik crowdsecurity/appsec-virtual-patching crowdsecurity/appsec-generic-rules"
      # Enable metrics
      METRICS_ENABLED: "true"
    volumes:
      # CrowdSec configuration and database
      - crowdsec-config:/etc/crowdsec
      - crowdsec-data:/var/lib/crowdsec/data
      # Mount Traefik access logs for analysis (crowdsecurity/traefik collection)
      - traefik-logs:/var/log/traefik:ro
      # Custom log acquisition rules (adds Traefik log source and AppSec component)
      - ./crowdsec/acquis.d:/etc/crowdsec/acquis.d:ro
    networks:
      - meshcentral-backend
      - meshcentral-frontend
    healthcheck:
      test: ["CMD", "cscli", "lapi", "status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    profiles:
      - crowdsec       # Only run when explicitly enabled
      - crowdsec-init  # Also start when running the init helper

  # CrowdSec Init Helper (Optional - only needed for automated setup)
  crowdsec-init:
    image: alpine:latest
    container_name: meshcentral-crowdsec-init
    depends_on:
      crowdsec:
        condition: service_healthy
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./scripts/init_crowdsec.sh:/init_crowdsec.sh:ro
      - ./meshcentral-data:/meshcentral-data
      # Traefik dynamic config dir – init script injects the Traefik bouncer API key
      - ./traefik/dynamic:/traefik/dynamic
    environment:
      CROWDSEC_CONTAINER: ${CROWDSEC_CONTAINER:-meshcentral-crowdsec}
      CROWDSEC_BOUNCER_NAME: ${CROWDSEC_BOUNCER_NAME:-meshcentral}
      CROWDSEC_LAPI_URL: ${CROWDSEC_LAPI_URL:-http://crowdsec:8080}
    networks:
      - meshcentral-backend
      - meshcentral-frontend
    command: sh -c "apk add --no-cache docker-cli jq && sh /init_crowdsec.sh"
    profiles:
      - crowdsec-init  # Only run when explicitly enabled

  # MeshCentral Server
  meshcentral:
    image: ghcr.io/ylianst/meshcentral:latest
    container_name: meshcentral-app
    restart: unless-stopped
    depends_on:
      mongodb:
        condition: service_healthy
      crowdsec:
        condition: service_healthy
        required: false  # Optional dependency
    environment:
      # Hostname configuration
      HOSTNAME: ${MESHCENTRAL_HOSTNAME}
      # Reverse proxy settings
      REVERSE_PROXY: ${REVERSE_PROXY:-traefik}
      REVERSE_PROXY_TLS_PORT: ${REVERSE_PROXY_TLS_PORT:-443}
      # MongoDB connection
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD}
      MONGO_URL: mongodb://${MESHCENTRAL_DB_USER}:${MESHCENTRAL_DB_PASSWORD}@mongodb:27017/${MONGO_DATABASE}
      # Node settings
      NODE_ENV: ${NODE_ENV:-production}
    volumes:
      - meshcentral-data:/opt/meshcentral/meshcentral-data
      - meshcentral-files:/opt/meshcentral/meshcentral-files
      - meshcentral-backup:/opt/meshcentral/meshcentral-backup
      - meshcentral-web:/opt/meshcentral/meshcentral-web
      # Rendered config - must be generated using render-config.sh before starting
      - ./meshcentral-data/config.json:/opt/meshcentral/meshcentral-data/config.json:ro
      # User allowed IP setting - uncomment to restrict to IPs in userallowedips.txt file
      # - ./meshcentral-data/userallowedips.txt:/opt/meshcentral/meshcentral-data/userallowedips.txt:ro
    labels:
      # Traefik routing labels (only used when the traefik profile is active)
      - "traefik.enable=true"
      # HTTPS router – main traffic via CrowdSec bouncer middleware
      - "traefik.http.routers.meshcentral.rule=Host(`${MESHCENTRAL_HOSTNAME}`)"
      - "traefik.http.routers.meshcentral.entrypoints=websecure"
      - "traefik.http.routers.meshcentral.tls=true"
      - "traefik.http.routers.meshcentral.middlewares=crowdsec@file"
      - "traefik.http.services.meshcentral.loadbalancer.server.port=4430"
      - "traefik.http.services.meshcentral.loadbalancer.server.scheme=http"
      - "traefik.docker.network=meshcentral-frontend"
      # HTTP router – redirect to HTTPS, also gated by CrowdSec
      - "traefik.http.routers.meshcentral-http.rule=Host(`${MESHCENTRAL_HOSTNAME}`)"
      - "traefik.http.routers.meshcentral-http.entrypoints=web"
      - "traefik.http.routers.meshcentral-http.middlewares=redirect-to-https@file,crowdsec@file"
    networks:
      - meshcentral-backend
      - meshcentral-frontend
    healthcheck:
      test: ["CMD", "curl", "-f", "-k", "http://127.0.0.1:4430/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Traefik Reverse Proxy
  # Traffic flow: Cloudflare Tunnel → Traefik (Origin Cert, HTTPS/443) → MeshCentral
  # TLS:
  #   - Cloudflare Origin Certificate is mounted at /etc/traefik/ssl/ (traefik/ssl/)
  #   - dynamic/tls.yml sets it as the default cert for the websecure (443) entrypoint
  #   - Cloudflare Tunnel service URL: https://traefik:443 (Full/Strict SSL mode)
  #   - Traefik → MeshCentral: HTTP on 4430 (TlsOffload recognises frontend subnet)
  # CrowdSec integration:
  #   - Traefik writes JSON access logs consumed by CrowdSec (crowdsecurity/traefik)
  #   - CrowdSec bouncer plugin middleware blocks flagged IPs at the Traefik layer
  #   - AppSec component provides WAF-style request inspection via port 7422
  traefik:
    image: traefik:v3
    container_name: meshcentral-traefik
    restart: unless-stopped
    depends_on:
      meshcentral:
        condition: service_healthy
    ports:
      - "${TRAEFIK_HTTP_PORT:-80}:80"
      - "${TRAEFIK_HTTPS_PORT:-443}:443"
    volumes:
      # Docker socket – read-only, for container label discovery
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Traefik static configuration
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      # Dynamic configuration directory (TLS store, CrowdSec middleware, HTTP→HTTPS redirect)
      # Watched by Traefik for live reloads; crowdsec-init writes the bouncer key here
      - ./traefik/dynamic:/etc/traefik/dynamic:ro
      # Cloudflare Origin Certificate – enables Full (Strict) SSL from Cloudflare Tunnel.
      # Place origin-cert.pem and origin-key.pem in traefik/ssl/ before starting.
      # See traefik/ssl/README.md for instructions.
      - ./traefik/ssl:/etc/traefik/ssl:ro
      # Persist access logs; CrowdSec mounts this volume for Traefik log analysis
      - traefik-logs:/var/log/traefik
    networks:
      - meshcentral-frontend
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:8082/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  # Prometheus – scrapes Traefik (:8082/metrics) and CrowdSec (:6060/metrics).
  # Placed on both meshcentral-monitoring (isolated backend) and meshcentral-frontend
  # so it can reach Traefik and CrowdSec metrics endpoints on the frontend network.
  # Start with: docker compose --profile monitoring up -d
  prometheus:
    image: prom/prometheus:latest
    container_name: meshcentral-prometheus
    restart: unless-stopped
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    networks:
      - meshcentral-monitoring
      - meshcentral-frontend  # Required to scrape traefik:8082 and crowdsec:6060
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    profiles:
      - monitoring

  # Loki – log aggregation backend; ingests Traefik access logs shipped by Promtail.
  # Used by Grafana to power the per-IP, per-URL, and per-browser dashboard panels.
  # Isolated to meshcentral-monitoring; not reachable from the frontend network.
  loki:
    image: grafana/loki:latest
    container_name: meshcentral-loki
    restart: unless-stopped
    command: -config.file=/etc/loki/loki.yml
    volumes:
      - ./monitoring/loki/loki.yml:/etc/loki/loki.yml:ro
      - loki-data:/loki
    networks:
      - meshcentral-monitoring
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3100/ready"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    profiles:
      - monitoring

  # Promtail – log collector; tails the Traefik JSON access log and ships to Loki.
  # Isolated to meshcentral-monitoring; reads logs via a shared volume (no network path needed
  # to Traefik) and pushes to Loki on the same monitoring network.
  promtail:
    image: grafana/promtail:latest
    container_name: meshcentral-promtail
    restart: unless-stopped
    command: -config.file=/etc/promtail/promtail.yml
    volumes:
      - ./monitoring/promtail/promtail.yml:/etc/promtail/promtail.yml:ro
      # Mount the same Traefik access log volume that CrowdSec also reads
      - traefik-logs:/var/log/traefik:ro
    networks:
      - meshcentral-monitoring
    depends_on:
      loki:
        condition: service_healthy
    profiles:
      - monitoring

  # Grafana – pre-provisioned with a Prometheus datasource and a combined
  # Traefik + CrowdSec metrics dashboard.
  # Accessible via Traefik on GRAFANA_HOSTNAME (set in .env).
  # On meshcentral-frontend for Traefik routing and meshcentral-monitoring for datasource access.
  grafana:
    image: grafana/grafana:latest
    container_name: meshcentral-grafana
    restart: unless-stopped
    depends_on:
      prometheus:
        condition: service_healthy
      loki:
        condition: service_healthy
        required: false  # Optional – skip if loki is not yet running
    environment:
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:?set GRAFANA_ADMIN_PASSWORD in .env}
      GF_AUTH_ANONYMOUS_ENABLED: "false"
      GF_SERVER_ROOT_URL: "https://${GRAFANA_HOSTNAME:?set GRAFANA_HOSTNAME in .env}"
    volumes:
      - grafana-data:/var/lib/grafana
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./monitoring/grafana/dashboards:/var/lib/grafana/dashboards:ro
    labels:
      # Traefik routing – accessible on its own public hostname via Cloudflare Tunnel.
      # Protect with a Cloudflare Access policy (recommended).
      - "traefik.enable=true"
      - "traefik.http.routers.grafana.rule=Host(`${GRAFANA_HOSTNAME}`)"
      - "traefik.http.routers.grafana.entrypoints=websecure"
      - "traefik.http.routers.grafana.tls=true"
      - "traefik.http.routers.grafana.middlewares=crowdsec@file"
      - "traefik.http.services.grafana.loadbalancer.server.port=3000"
      - "traefik.docker.network=meshcentral-frontend"
    networks:
      - meshcentral-frontend    # Traefik can proxy to Grafana on this network
      - meshcentral-monitoring  # Grafana can reach Prometheus and Loki on this network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    profiles:
      - monitoring

  # Cloudflared Tunnel (Optional - remove if not using Cloudflare Tunnel)
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: meshcentral-cloudflared
    restart: unless-stopped
    depends_on:
      traefik:
        condition: service_healthy
        required: false  # Optional – only needed when using the traefik profile
    command: tunnel --no-autoupdate run --token ${CLOUDFLARE_TUNNEL_TOKEN}
    networks:
      - meshcentral-frontend
    profiles:
      - cloudflare  # Only start when explicitly enabled

networks:
  meshcentral-frontend:
    name: meshcentral-frontend
    driver: bridge
    internal: false
    ipam:
      config:
        - subnet: 172.19.0.0/16
  meshcentral-backend:
    name: meshcentral-backend
    driver: bridge
    internal: true
  meshcentral-monitoring:
    name: meshcentral-monitoring
    driver: bridge
    internal: true

volumes:
  mongodb-data:
    driver: local
  mongodb-config:
    driver: local
  meshcentral-data:
    driver: local
  meshcentral-files:
    driver: local
  meshcentral-backup:
    driver: local
  meshcentral-web:
    driver: local
  crowdsec-config:
    driver: local
  crowdsec-data:
    driver: local
  traefik-logs:
    driver: local
  prometheus-data:
    driver: local
  loki-data:
    driver: local
  grafana-data:
    driver: local

services:
  # MongoDB Database
  mongodb:
    image: mongo:7
    container_name: meshcentral-mongodb
    restart: unless-stopped
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD}
      MONGO_INITDB_DATABASE: ${MONGO_DATABASE}
      MESHCENTRAL_USER: ${MESHCENTRAL_DB_USER}
      MESHCENTRAL_PASSWORD: ${MESHCENTRAL_DB_PASSWORD}
    volumes:
      - mongodb-data:/data/db
      - mongodb-config:/data/configdb
      - ./mongo-init/init-mongo.js:/docker-entrypoint-initdb.d/init-mongo.js:ro
    networks:
      - meshcentral-backend
    command: 
      - --auth
      # Enable encryption at rest (requires keyfile configuration in production)
      # - --enableEncryption
      # - --encryptionKeyFile=/etc/mongodb-keyfile
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/${MONGO_DATABASE} --quiet
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # CrowdSec Security Engine (Optional - comment out if not using)
  crowdsec:
    image: crowdsecurity/crowdsec:latest
    container_name: meshcentral-crowdsec
    restart: unless-stopped
    environment:
      # CrowdSec collections to install
      # crowdsecurity/traefik parses Traefik JSON access logs
      COLLECTIONS: "crowdsecurity/http-cve crowdsecurity/whitelist-good-actors crowdsecurity/iptables crowdsecurity/linux crowdsecurity/traefik"
      # Enable metrics
      METRICS_ENABLED: "true"
    volumes:
      # CrowdSec configuration and database
      - crowdsec-config:/etc/crowdsec
      - crowdsec-data:/var/lib/crowdsec/data
      # Mount Traefik access logs for analysis (crowdsecurity/traefik collection)
      - traefik-logs:/var/log/traefik:ro
      # Mount WAF logs for analysis (when using the waf profile)
      - waf-logs:/var/log/nginx:ro
      # Custom log acquisition rules (adds Traefik log source)
      - ./crowdsec/acquis.d:/etc/crowdsec/acquis.d:ro
    networks:
      - meshcentral-backend
      - meshcentral-frontend
    healthcheck:
      test: ["CMD", "cscli", "version"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    profiles:
      - crowdsec       # Only start when explicitly enabled
      - crowdsec-init  # Also start when running the init helper

  # CrowdSec Init Helper (Optional - only needed for automated setup)
  crowdsec-init:
    image: alpine:latest
    container_name: meshcentral-crowdsec-init
    depends_on:
      crowdsec:
        condition: service_healthy
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./scripts/init_crowdsec.sh:/init_crowdsec.sh:ro
      - ./meshcentral-data:/meshcentral-data
      # Traefik dynamic config dir – init script injects the Traefik bouncer API key
      - ./traefik/dynamic:/traefik/dynamic
    environment:
      CROWDSEC_CONTAINER: ${CROWDSEC_CONTAINER:-meshcentral-crowdsec}
      CROWDSEC_BOUNCER_NAME: ${CROWDSEC_BOUNCER_NAME:-meshcentral}
      CROWDSEC_LAPI_URL: ${CROWDSEC_LAPI_URL:-http://crowdsec:8080}
    networks:
      - meshcentral-backend
      - meshcentral-frontend
    command: sh -c "apk add --no-cache docker-cli jq && sh /init_crowdsec.sh"
    profiles:
      - crowdsec-init  # Only run when explicitly enabled

  # MeshCentral Server
  meshcentral:
    image: ghcr.io/ylianst/meshcentral:latest
    container_name: meshcentral-app
    restart: unless-stopped
    depends_on:
      mongodb:
        condition: service_healthy
      crowdsec:
        condition: service_healthy
        required: false  # Optional dependency
    environment:
      # Hostname configuration
      HOSTNAME: ${MESHCENTRAL_HOSTNAME}
      # Reverse proxy settings
      REVERSE_PROXY: ${REVERSE_PROXY:-nginx}
      REVERSE_PROXY_TLS_PORT: ${REVERSE_PROXY_TLS_PORT:-443}
      # MongoDB connection
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_ROOT_PASSWORD}
      MONGO_URL: mongodb://${MESHCENTRAL_DB_USER}:${MESHCENTRAL_DB_PASSWORD}@mongodb:27017/${MONGO_DATABASE}
      # Node settings
      NODE_ENV: ${NODE_ENV:-production}
    volumes:
      - meshcentral-data:/opt/meshcentral/meshcentral-data
      - meshcentral-files:/opt/meshcentral/meshcentral-files
      - meshcentral-backup:/opt/meshcentral/meshcentral-backup
      - meshcentral-web:/opt/meshcentral/meshcentral-web
      # Rendered config - must be generated using render-config.sh before starting
      - ./meshcentral-data/config.json:/opt/meshcentral/meshcentral-data/config.json:ro
      # User allowed IP setting - uncomment to restrict to IPs in userallowedips.txt file
      # - ./meshcentral-data/userallowedips.txt:/opt/meshcentral/meshcentral-data/userallowedips.txt:ro
    labels:
      # Traefik routing labels (only used when the traefik profile is active)
      - "traefik.enable=true"
      # HTTPS router – main traffic via CrowdSec bouncer middleware
      - "traefik.http.routers.meshcentral.rule=Host(`${MESHCENTRAL_HOSTNAME}`)"
      - "traefik.http.routers.meshcentral.entrypoints=websecure"
      - "traefik.http.routers.meshcentral.tls=true"
      - "traefik.http.routers.meshcentral.middlewares=crowdsec@file"
      - "traefik.http.services.meshcentral.loadbalancer.server.port=4430"
      - "traefik.http.services.meshcentral.loadbalancer.server.scheme=http"
      # HTTP router – redirect to HTTPS, also gated by CrowdSec
      - "traefik.http.routers.meshcentral-http.rule=Host(`${MESHCENTRAL_HOSTNAME}`)"
      - "traefik.http.routers.meshcentral-http.entrypoints=web"
      - "traefik.http.routers.meshcentral-http.middlewares=redirect-to-https@file,crowdsec@file"
    networks:
      - meshcentral-backend
      - meshcentral-frontend
    healthcheck:
      test: ["CMD", "curl", "-f", "-k", "http://127.0.0.1:4430/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # WAF – nginx + ModSecurity + OWASP CRS (default reverse proxy)
  # Traffic flow: cloudflared → waf → meshcentral
  # Built from waf/Dockerfile (nginx:alpine base; ModSecurity v3, ModSecurity-nginx
  # connector, and OWASP CRS compiled from source).
  # nginx config (waf/default.conf) and ModSecurity settings (waf/modsecurity.conf)
  # are copied into the image at build time.
  # Rebuild after config changes: docker compose build waf
  waf:
    build:
      context: ./waf
      dockerfile: Dockerfile
    container_name: meshcentral-waf
    restart: unless-stopped
    depends_on:
      meshcentral:
        condition: service_healthy
    ports:
      - "${WAF_HTTP_PORT:-80}:80"
      - "${WAF_HTTPS_PORT:-443}:443"
    volumes:
      # ModSecurity engine settings (SecRuleEngine mode, body limits, audit logging).
      # Baked into the image at build time; this bind-mount overrides the baked-in
      # copy at runtime, so you can tune SecRuleEngine / limits with only a
      # container restart instead of a full image rebuild.
      - ./waf/modsecurity.conf:/etc/modsecurity.d/modsecurity.conf:ro
      # Persist WAF logs; CrowdSec mounts this volume for log analysis
      - waf-logs:/var/log/nginx
      # TLS certificates for the HTTPS listener.
      # Place your files in waf/ssl/ and uncomment when terminating TLS at the WAF:
      # - ./waf/ssl/cert.pem:/etc/nginx/ssl/cert.pem:ro
      # - ./waf/ssl/key.pem:/etc/nginx/ssl/key.pem:ro
    networks:
      - meshcentral-frontend
    # Health check verifies that the nginx process is accepting connections.
    # End-to-end connectivity to MeshCentral is guaranteed at startup via
    # depends_on (service_healthy on the meshcentral container).
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:80/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    profiles:
      - waf # Only start when explicitly enabled

  # Traefik Reverse Proxy (Optional – use instead of waf when Traefik-native routing,
  # Docker label-based service discovery, and the CrowdSec bouncer plugin are preferred)
  # Traffic flow: Cloudflare Tunnel → Traefik (Origin Cert, HTTPS/443) → MeshCentral
  # TLS:
  #   - Cloudflare Origin Certificate is mounted at /etc/traefik/ssl/ (traefik/ssl/)
  #   - dynamic/tls.yml sets it as the default cert for the websecure (443) entrypoint
  #   - Cloudflare Tunnel service URL: https://traefik:443 (Full/Strict SSL mode)
  #   - Traefik → MeshCentral: HTTP on 4430 (TlsOffload recognises frontend subnet)
  # CrowdSec integration:
  #   - Traefik writes JSON access logs consumed by CrowdSec (crowdsecurity/traefik)
  #   - CrowdSec bouncer plugin middleware blocks flagged IPs at the Traefik layer
  #   - MeshCentral bouncer also remains active for defence-in-depth
  # NOTE: Do not run both traefik and waf at the same time on the same host ports.
  #       Change TRAEFIK_HTTP_PORT / TRAEFIK_HTTPS_PORT in .env if needed.
  traefik:
    image: traefik:v3
    container_name: meshcentral-traefik
    restart: unless-stopped
    depends_on:
      meshcentral:
        condition: service_healthy
    ports:
      - "${TRAEFIK_HTTP_PORT:-80}:80"
      - "${TRAEFIK_HTTPS_PORT:-443}:443"
    volumes:
      # Docker socket – read-only, for container label discovery
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # Traefik static configuration
      - ./traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      # Dynamic configuration directory (TLS store, CrowdSec middleware, HTTP→HTTPS redirect)
      # Watched by Traefik for live reloads; crowdsec-init writes the bouncer key here
      - ./traefik/dynamic:/etc/traefik/dynamic:ro
      # Cloudflare Origin Certificate – enables Full (Strict) SSL from Cloudflare Tunnel.
      # Place origin-cert.pem and origin-key.pem in traefik/ssl/ before starting.
      # See traefik/ssl/README.md for instructions.
      - ./traefik/ssl:/etc/traefik/ssl:ro
      # Persist access logs; CrowdSec mounts this volume for Traefik log analysis
      - traefik-logs:/var/log/traefik
    networks:
      - meshcentral-frontend
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:8082/ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    profiles:
      - traefik  # Only start when explicitly enabled

  # Caddy Reverse Proxy (Optional – use instead of waf when automatic HTTPS via
  # Let's Encrypt / Cloudflare DNS challenge is preferred over nginx+ModSecurity)
  caddy:
    build:
      context: ./caddy
      dockerfile: Dockerfile
    container_name: meshcentral-caddy
    restart: unless-stopped
    depends_on:
      meshcentral:
        condition: service_healthy
    ports:
      - "${CADDY_HTTP_PORT:-80}:80"
      - "${CADDY_HTTPS_PORT:-443}:443"
      - "${CADDY_ADMIN_PORT:-2019}:2019"
    environment:
      ACME_EMAIL: ${ACME_EMAIL}
      CLOUDFLARE_API_TOKEN: ${CLOUDFLARE_API_TOKEN}
      MESHCENTRAL_HOSTNAME: ${MESHCENTRAL_HOSTNAME}
    volumes:
      # Caddyfile with environment variable substitution
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy-data:/data
      - caddy-config:/config
    networks:
      - meshcentral-frontend
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:2019/config/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    profiles:
      - caddy  # Only start when explicitly enabled

  # Cloudflared Tunnel (Optional - remove if not using Cloudflare Tunnel)
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: meshcentral-cloudflared
    restart: unless-stopped
    depends_on:
      waf:
        condition: service_healthy
        required: false  # Not required when using the traefik profile instead
      traefik:
        condition: service_healthy
        required: false  # Not required when using the waf profile instead
    command: tunnel --no-autoupdate run --token ${CLOUDFLARE_TUNNEL_TOKEN}
    networks:
      - meshcentral-frontend
    profiles:
      - cloudflare  # Only start when explicitly enabled

networks:
  meshcentral-frontend:
    driver: bridge
    internal: false
    ipam:
      config:
        - subnet: 172.19.0.0/16
  meshcentral-backend:
    driver: bridge
    internal: true

volumes:
  mongodb-data:
    driver: local
  mongodb-config:
    driver: local
  meshcentral-data:
    driver: local
  meshcentral-files:
    driver: local
  meshcentral-backup:
    driver: local
  meshcentral-web:
    driver: local
  caddy-data:
    driver: local
  caddy-config:
    driver: local
  crowdsec-config:
    driver: local
  crowdsec-data:
    driver: local
  waf-logs:
    driver: local
  traefik-logs:
    driver: local
